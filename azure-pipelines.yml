trigger:
  branches:
    include:
      - main

pool:
  name: 'managed-pool-agents'

variables:
  imageName: 'insecure-demo-app'
  imageTag: '$(Build.BuildId)'
  fullImage: '$(imageName):$(imageTag)'

steps:
  - checkout: self

  # Install Docker + wget on the managed agent
  - script: |
      sudo apt-get update -y
      sudo apt-get install -y docker.io wget
      docker --version
    displayName: 'Install Docker and tools'

  # Build the container image
  - script: |
      sudo docker build -t $(fullImage) .
    displayName: 'Build image'

  # Install Trivy and scan the image
  - script: |
      wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.tar.gz
      tar zxvf trivy_Linux-64bit.tar.gz
      sudo mv trivy /usr/local/bin/
      trivy image \
        --severity HIGH,CRITICAL \
        --vuln-type os,library \
        --ignore-unfixed \
        --exit-code 1 \
        $(fullImage)
    displayName: 'Scan image'

  # Only runs if scan passed
  - script: |
      sudo docker run --rm -d --name test-container -p 8080:80 $(fullImage)
      sleep 5
      sudo docker stop test-container
    displayName: 'Smoke test'
    condition: succeeded()